---
title: "Data challenge: data exploration"
author:
- name: Bénédicte Colnet
  affiliation: Inria
date: "March 2021, 22nd"
output:
  pdf_document:
    toc: yes
  html_document:
    number_sections: no
    toc: yes
    toc_depth: 2
keywords: data exploration; data management; confidence interval; matching
abstract: | 
  In this notebook the notions presented in the first class are used, such as data loading, data exploration, data management, and also computation of point estimates and their confidence intervals. First, this notebook proposes data exploration proceadure. Note that on the contrary to the Python notebook, it is less standardized (in term of string management or column processing), because we do not propose a pipeline to process data, but we rather propose to explore the data. This notebook contains simple, and less simple, plots using the library `ggplot2`. Don't hesitate to improve these plots to go further, but also to propose totally new representations. Their is not only one good way to visualize data, but rather plenty of ways. The end of the notebook proposes to study the salary difference between men and women and recalls how to compare the means of two groups with a proper confidence interval. The last code chunk proposes to match individuals with respect to their job class, and could be the first step to explain the salary difference previously measured.
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r,warning=FALSE}
library(ggplot2) # for histogram
library(lubridate) # for date management
library(dplyr)
library(stringr)
```


```{r}
salaries <- read.csv(file = "./data/train_data.csv")
```

## Clean data

```{r}
# remove useless spaces in the sex names
salaries$SEX <- str_replace_all(salaries$SEX, '\\s+', "")
```



## Time since employment
```{r}
# Change date using package lubridate
salaries$date <- mdy(salaries$HIREDT)
# correct error for 2068
salaries[111174, "date"] <- "1968-12-01"


salaries$nb_months_since_start <- interval(salaries$date, "2021-03-01") %/% months(1)
salaries$nb_years_since_start <- floor(salaries$nb_months_since_start/12)
# create starting month and starting year
salaries$employ_start_month <- month(salaries$date, label = TRUE, abbr = FALSE)
salaries$employ_start_year <- year(salaries$date)
```


```{r}
library(ggplot2)
ggplot(salaries, aes(x = nb_months_since_start)) +
  geom_histogram(binwidth = 6, alpha = 0.5, color = "darkblue") + # semester
  theme_bw() +
  ggtitle("Number of months since employment")

ggplot(salaries, aes(x = employ_start_month)) +
  geom_bar(alpha = 0.5, color = "darkblue") + 
  theme_bw() +
  ggtitle("Starting Month")

ggplot(salaries, aes(x = employ_start_year)) +
  geom_histogram(binwidth = 1, alpha = 0.5, color = "darkblue") +
  theme_bw() +
  ggtitle("Starting year")
```


```{r}
## solution de Tristan
# pacman::p_load(tidyverse, lubridate)
# raw_df <- read_csv("data/train_data.csv")
# data_df <-
#   raw_df %>%
#   mutate(HIREDT = parse_date_time2(HIREDT, "mdy", cutoff_2000 = 50L)) %>%
#   arrange(desc(HIREDT))
```

## ANNUAL quick description

```{r}
ggplot(salaries, aes(x = log(ANNUAL))) +
  geom_histogram(fill  = "pink", color = "grey") +
  facet_grid(~SEX) +
  theme_classic()
```

```{r}
ggplot(salaries, aes(x = SEX, y = log(ANNUAL))) +
  geom_violin(fill  = "blue", color = "grey") +
  #geom_jitter(alpha = 0.3, width = 0.2) +
  facet_wrap(~RACE) +
  theme_classic()
```

```{r}
table(salaries$RACE)
```



```{r}
ggplot(salaries, aes(y = nb_months_since_start, x = log(ANNUAL), color = SEX)) +
  geom_point(alpha = 0.3) +
  theme_classic()

ggplot(salaries, aes(y = nb_months_since_start, x = log(ANNUAL), color = EMPTYPE)) +
  geom_point(alpha = 0.3) +
  theme_classic()
```

Emptype is probably very useful when doing the prediction task (at least for extreme wages prediction)! Also, interestingly, some emptype seem to have the same salaries no matter the experience in the administration.

```{r}
salaries[, c("EMPTYPE", "nb_years_since_start", "ANNUAL")] %>%
  group_by(EMPTYPE, nb_years_since_start) %>%
  summarise(mean_annual = mean(ANNUAL), n = n())
```



```{r}
salaries %>%
  group_by(EMPTYPE, nb_years_since_start) %>%
  summarise(mean_annual = mean(ANNUAL), n = n()) %>%
  ggplot(aes(y = mean_annual, x = EMPTYPE, size = n, colour = nb_years_since_start)) +
  geom_point() +
  scale_size(range = c(2, 12)) + 
  coord_flip() +
  scale_colour_gradientn(colours = terrain.colors(10)) +
  theme_bw()
```

Is MI important?

```{r}
salaries %>%
  group_by(MI, nb_years_since_start) %>%
  summarise(mean_annual = mean(ANNUAL), n = n()) %>%
  ggplot(aes(y = mean_annual, x = MI, size = n), colour = nb_years_since_start) +
  geom_point(aes(colour = nb_years_since_start)) +
  scale_size(range = c(2, 12)) + 
  coord_flip() +
  scale_colour_gradientn(colours = terrain.colors(10)) +
  theme_bw()
```

MI does not seem correlated to the progression in time, and not so related to a specific mean salary.

```{r}
library(forcats) # reorder
salaries %>%
  group_by(JOBCLASS) %>%
  summarise(mean_annual = mean(ANNUAL), n = n()) %>%
  mutate(JOBCLASS = fct_reorder(JOBCLASS, desc(mean_annual))) %>%
  ggplot(aes(x = JOBCLASS, y = mean_annual)) +
  geom_bar(stat="identity", fill="#f68060", alpha=.6, width=.4) +
  scale_size(range = c(2, 12)) + 
  theme_bw()
```

JOBCLASS seems important also.

```{r}
salaries %>%
  group_by(EMPTYPE, SEX) %>%
  summarise(mean_annual = mean(ANNUAL)) %>%
  ggplot(aes(SEX, EMPTYPE, fill = mean_annual)) +
  geom_tile(colour = "white") +
  scale_fill_gradient(low="red", high="green") +
  labs(x="Race",
       y="EMPTYPE",
       fill="Mean annual salary")
```


```{r}
ggplot(salaries, aes(x = RACE, y = ANNUAL)) +
  geom_boxplot() +
  theme_light()
```

```{r}
tmp <-salaries %>%
  group_by(RACE, SEX) %>%
  summarise(mean_exp = mean(nb_months_since_start), mean_annual = mean(ANNUAL), count = n())

tmp

# here are others command lines that could be useful to pivot your data
#pivot_longer()
#pivot_wider()
```



## Effect of gender

A first naive approach is to compare the mean of the two groups.

```{r}
mean(salaries[salaries$SEX == "MALE", "ANNUAL"]) - mean(salaries[salaries$SEX == "FEMALE", "ANNUAL"])
```

We observe a difference, but is it significant?

Here is the detailed code to measure the difference in means between women and men, and the confidence interval.

To compute the confidence interval, it uses the central limit theorem, and the fact that the empirical mean converges toward a normal distribution. So that we can estimate the confidence interval with a typical gaussian density function (it corresponds to the line with the 1.96)

```{r}
# Filter treatment / control observations, pulls outcome variable as a vector
target_women <- salaries[salaries$SEX == "FEMALE", "ANNUAL"] # Outcome for women
target_men <- salaries[salaries$SEX == "MALE", "ANNUAL"] # Outcome for men
  
n_women <- nrow(salaries[salaries$SEX == "FEMALE",]) # Number of women
n_men <- nrow(salaries[salaries$SEX == "MALE",]) # Number of men
  
# Difference in means
estimated_difference <- mean(target_men) - mean(target_women)
  
# 95% Confidence intervals
se_hat <- sqrt(var(target_women)/(n_women-1) + var(target_men)/(n_men-1) )
lower_ci <- estimated_difference - 1.96 * se_hat
upper_ci <- estimated_difference + 1.96 * se_hat
  
result = c(Difference = estimated_difference, lower_ci = lower_ci, upper_ci = upper_ci)
print(result)
```
We find that men have a higher wage than women + 6479, and the confidence interval CI[6185 - 6772] allows to say it is significant.

You can also use the regular R command we presented in class, and check we have the same result (the small difference is probably due to the fact that in the manual coded version we used 1.96)

```{r}
t.test(target_women, target_men)
```

Don't forget to provide confidence interval rather than point estimate! If you don't understand the whole process to compute the confidence interval is not so important. The most important thing is to remember how to compute the confidence interval when you have to compare the means of two groups, or at least to remember that this is a key information before sketching the conclusion.

Usually the result in newspaper is in percentage.

```{r}
mean_men = mean(target_men)
mean_women = mean(target_women)
percentage = mean_men/mean_women
percentage = (percentage-1)*100
percentage
```
On average, men are paid 13% more than women.

But, is it due to the fact that women are women, so that they are less paid? Or is it due to the fact that men occupy different work position than women?

How can we get a little bit further than the naive difference in means? 

For example, we can investigate if there is a difference in the salary for women and men with same job and ethnicity. If we observe a difference, we could suppose that sexism exists. If not, the salary difference is probably due to the fact that women occupy different work categories. 

>N.B: we have no judgment on this political and sociological question, but understanding the reason for this difference is very important before drawing any public policy. This question highlights how complicated such a question can be.

```{r}
# For matching

library(MatchIt)
covariates_to_keep <- c("SEX", "RACE", "EMPTYPE", "NAME", "JC.TITLE")
m.out <- matchit(SEX ~ ., method = "exact", data = salaries[, covariates_to_keep])
salaries.matched <- match.data(m.out)

# # you can check that each subgroup is the same respectively to the covariates chosen to match 
engineer <- salaries.matched[salaries.matched$subclass == 10,]
```






